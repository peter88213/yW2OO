""" yWriter to OpenOffice conversion tool.

@summary: Postprocessor for yWriter html export to make it suitable 
    for Open/LibreOffice Writer
    *   This script removes several unwanted tags generated by yWriter, 
        such as table and font specification.
    *   This script sets Chapter headings to "Heading 2" 
        and modifies the String "Chapter" if you wish.
    *   This script sets Scene headings to "Heading 4".
    *   It is assumed that in Writer, default paragraphs will be 
        set to "First-line indent" manually or by macro.  
    *   This script sets the first paragraph of each chapter 
        and scene to "Heading 6"
    *   It is assumed that in Writer, "Heading 6" paragraphs will be 
        set to "Text body" manually or by macro.
    *   This script converts "italic" and "bold" into "emphasized" 
        and "strong" according to Writer's character styles.
    *   This script converts US dashes into european dashes if spaced.
    *   This script converts spaces before dashes and ellipses 
        into non-breaking space characters.
    *   This script removes empty paragraphs within scenes.
@author: Peter Triesberger
@see: https://github.com/peter88213/yW2OO
@license: The MIT License 
    (https://opensource.org/licenses/mit-license.php)
@copyright: (c) 2019, Peter Triesberger
@return: Exit code 
    0 if no error occurred; 
    1 if any error occurred.
@precondition: The file "Exported Project.html" must exist 
    with r/w access in the working directory.
@postcondition: The file "Exported Project.html" is modified 
    (see summary).
@since: 2018-10-01
"""
import sys

VERSION = 'v1.9.3'

# Don't forget to set the correct version number!
START_MESSAGE = "\nyW2OO - Structuring yWriter's html export " + VERSION

# (yWriter: "Project>Export Project>to html").
HTML_FILE = 'Exported Project.html'

DELIMITER = '|'


# Replacements to be made (see search_and_replace()):
# NOTE: Double quotes are required
# because search strings contain single quotes.
htmlReplaceList = [
    "<p align='justify'><i>&nbsp;</i></p>\n<p class='Para'>|<H6>|",
    "<br /><br /><br /><center>&nbsp;</center><br /><br />\n\n<p class='Para'>|<H4>* * *</H4>\n<H6>|",
    "<br /><br /><br /><center>*</center><br /><br />\n\n<p class='Para'>|<H4>*</H4>\n<H6>|",
    "<br /><br /><br /><center>* * *</center><br /><br />\n\n<p class='Para'>|<H4>* * *</H4>\n<H6>|",
    "<br /><br /><br /><center>#</center><br /><br />\n\n<p class='Para'>|<H4>#</H4>\n<H6>|",
    "<br /><br /><br /><center>-=#=-</center><br /><br />\n\n<p class='Para'>|<H4>-=#=-</H4>\n<H6>|",
    "<br /><br /><br /><center>&bull;</center><br /><br />\n\n<p class='Para'>|<H4>&bull;</H4>\n<H6>|",
    "<center></center>\n\n<p class='Para'>|<H4>* * *</H4>\n<H6>|",
    "<center>&nbsp;</center>\n\n<p class='Para'>|<H4>* * *</H4>\n<H6>|",
    "<center>*</center>\n\n<p class='Para'>|<H4>*</H4>\n<H6>|",
    "<center>* * *</center>\n\n<p class='Para'>|<H4>* * *</H4>\n<H6>|",
    "<center>#</center>\n\n<p class='Para'>|<H4>#</H4>\n<H6>|",
    "<center>-=#=-</center>\n\n<p class='Para'>|<H4>-=#=-</H4>\n<H6>|",
    "<center>&bull;</center>\n\n<p class='Para'>|<H4>&bull;</H4>\n<H6>|",
    "<table align=center border=0 width=790>||",
    "<tr><td>||",
    "<font name='arial' size=+1>||",
    "</font>||",
    "</td></tr></table>||",
    "<p align='justify'><i>&nbsp;</i></p>||",
    "<p class='Para'></p>||",
    "</b></center>|</H2>|",
    "<center><b>|<H2>|",
    "<p class='chapter'>|<H2>|",
    "Chapter ||",
    "<b>|<STRONG>|",
    "</b>|</STRONG>|",
    "<i>|<EM>|",
    "</i>|</EM>|",
    "&mdash;|--|",
    "  | |",
    "  | |",
]


def search_and_replace(processData, replaceList):
    """ Multiple search and replace text in a string

    @summary: Modifying a string by looping through a list of search/replacement items.
    @param: processData: string to be modified.
    @param: replaceList: list of strings containing search/replacement items. 
        Structure of each list element: "<search item>|<replacement item>|" 
        The replacement item can be empty.  
    @return: Modified string, None if input data is misformatted.
    """
    for line in replaceList:
        if line.count(DELIMITER) == 2:
            replaceItem = line.split(DELIMITER)
            processData = processData.replace(replaceItem[0], replaceItem[1])
        else:
            return(None)
    return(processData)


def main():
    """ Clean up and structure yWriter's html export. """
    print(START_MESSAGE)
    try:
        with open(HTML_FILE, 'r') as f:
            htmlData = f.read()
    except IOError:
        print('ERROR: Cannot read "' + HTML_FILE + '"!\n')
        sys.exit(1)

    htmlData = search_and_replace(htmlData, htmlReplaceList)
    assert htmlData != None

    try:
        with open(HTML_FILE, 'w') as f:
            f.write(htmlData)
    except IOError:
        print('ERROR: Cannot write "' + HTML_FILE + '"!\n')
        sys.exit(1)

    print('"' + HTML_FILE + '" successfully processed.\n')
    return(0)


if __name__ == '__main__':
    main()
